<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Intel CPU Microcode Updates Directly into the Linux Kernel | DOTSLASHLINUX</title>
    <meta name="description" content="DOTSLASHLINUX is a GNU/Linux enthusiasts' hub, featuring configuration guides for the linux kernel and several lightweight open source and free software.">
    <meta name="author" content="Firas Khalil Khana">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="css/c.css">
    <link rel="alternate" type="application/rss+xml" title="DOTSLASHLINUX RSS" href="/feed.xml">
  </head>
  <body>
    <div class="row middle-xs middle-sm middle-md middle-lg container">
      <div class="col-xs-12 center-xs col-sm-4 start-sm col-md-4 start-md col-lg-4 start-lg">
        <div class="box brand">
          <h1><a href="https://www.dotslashlinux.com/">DOTSLASHLINUX</a></h1>
        </div>
      </div>
      <div class="col-xs-12 center-xs col-sm-8 end-sm col-md-8 end-md col-lg-8 end-lg">
        <div class="box">
          <nav>
            <ul>
              <li class=""><a href="/">HOME</a></li>
              <li class=""><a href="/page/search/">SEARCH</a></li>
              <li><a href="/index.xml" style="color: #f26522;">RSS</a></li>
            </ul>
          </nav>
        </div>
      </div>
      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 content">
        <div class="box patreon">
          <p>Kindly support DOTSLASHLINUX on <a href="https://www.patreon.com/DOTSLASHLINUX" target="_target">Patreon</a> to keep the website up and running while remaining ads free.</p>
        </div>


<div class="box map">
  <h2>Building Intel CPU Microcode Updates Directly into the Linux Kernel</h2>
  <div class="share">
    <a id="facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.dotslashlinux.com%2fpost%2fbuilding-intel-cpu-microcode-updates-directly-into-the-linux-kernel%2f" rel="nofollow" target="_blank">Facebook</a>
    <a id="twitter" href="https://www.twitter.com/intent/tweet?source=https%3a%2f%2fwww.dotslashlinux.com%2fpost%2fbuilding-intel-cpu-microcode-updates-directly-into-the-linux-kernel%2f&text=https%3a%2f%2fwww.dotslashlinux.com%2fpost%2fbuilding-intel-cpu-microcode-updates-directly-into-the-linux-kernel%2f" rel="nofollow" target="_blank">Twitter</a>
    <a id="googleplus" href="https://plus.google.com/share?url=https%3a%2f%2fwww.dotslashlinux.com%2fpost%2fbuilding-intel-cpu-microcode-updates-directly-into-the-linux-kernel%2f" rel="nofollow" target="_blank">Google+</a>
    <a id="reddit" href="https://www.reddit.com/submit?url=https%3a%2f%2fwww.dotslashlinux.com%2fpost%2fbuilding-intel-cpu-microcode-updates-directly-into-the-linux-kernel%2f" rel="nofollow" target="_blank">Reddit</a>
    <a id="linkedin" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.dotslashlinux.com%2fpost%2fbuilding-intel-cpu-microcode-updates-directly-into-the-linux-kernel%2f&source=https%3a%2f%2fwww.dotslashlinux.com%2fpost%2fbuilding-intel-cpu-microcode-updates-directly-into-the-linux-kernel%2f" rel="nofollow" target="_blank">LinkedIn</a>
  </div>
  <div class="frame"><a href="/img/microcode.png" target="_blank"><img src="/img/microcode.png" alt="microcode"></div></a>
    <div class="info">Firas Khalil Khana | 30/04/2017</div>
    <p><mark>DOTSLASHLINUX is proud to say that part of this article was added to the <a href="https://wiki.gentoo.org/wiki/Intel_microcode#Kernel_3" target="_blank">Gentoo Wiki</a></mark>
<br/>
<br/>
To achieve our dream of booting the kernel without an initrd/initramfs we have to build our CPU&rsquo;s microcode updates directly into the linux kernel (removing any need for an initrd/initramfs). This is doable, but due to lack of documentation on the process, one may find this thing hard to do. Yes, I know, that&rsquo;s why DOTSLASHLINUX was created xD.
<br/>
<br/>
For those who&rsquo;d like to know, I&rsquo;m using Gentoo Linux. Any distro will be fine though, as long as you can access your kernel&rsquo;s source files. The version of the kernel&rsquo;s source files that I&rsquo;m using is 4.10.13.
<hr/></p>

<p><h3>1. Getting Ready</h3>
<br/>
Fire up your favorite terminal emulator, navigate to your kernel&rsquo;s source folder:</p>

<pre><code class="language-bash">cd /usr/src/linux
</code></pre>

<p><br/>
Now make sure you have <mark>ncurses</mark> installed and type in:</p>

<pre><code class="language-bash">make menuconfig
</code></pre>

<p><br/>
If you don&rsquo;t have ncurses installed you can use:
<br/>
<ul>
<li><mark>make gconfig</mark> if you had <mark>GTK</mark> installed</li>
<li><mark>make xconfig</mark> if you had <mark>Qt</mark> installed</li>
</ul>
<br/>
I personally prefer <mark>make menuconfig</mark> as it&rsquo;s better maintained and can be accessed from your terminal emulator or from a TTY. But as long as you can store your changes whenever you want, and go back and forth with the configuration menus then you&rsquo;re good to go.
<br/>
<hr/>
<h3>2. Enable CPU Microcode Loading Support</h3>
<br/>
Navigate to <mark>Processor type and features</mark> and mark <mark>CONFIG_MICROCODE</mark> as built-in. You&rsquo;ll receive two options now &ldquo;Blue vs Red&rdquo; microcode loading support or should I say <mark>CONFIG_MICROCODE_INTEL</mark> vs <mark>CONFIG_MICROCODE_AMD</mark>.</p>

<pre><code class="language-properties">  [∗] DMA memory allocation support
  [∗] Symmetric multi-processing support
  [ ] Enable MPS table
  [ ] Intel Resource Director Technology Allocation support
  [ ] Support for extended (non-PC) x86 platforms
  [ ] Intel Low Power Subsystem Support
  [ ] AMD ACPI2Platform devices support
  &lt; &gt; Intel SoC IOSF Sideband support for SoC platforms
  [ ] Single-depth WCHAN output
  [ ] Linux guest support  ----
  Processor family (Core 2/newer Xeon)  ---&gt;
  [∗] Supported processor vendors  ---&gt;
  [∗] Enable DMI scanning
  [ ] IBM Calgary IOMMU support
  [ ] Enable Maximum number of SMP Processors and NUMA Nodes
  (8) Maximum number of CPUs
  [∗] SMT (Hyperthreading) scheduler support
  [∗] Multi-core scheduler support
  [∗]   CPU core priorities scheduler support
  Preemption Model (No Forced Preemption (Server))  ---&gt;
  [ ] Reroute for broken boot IRQs
  [∗] Machine Check / overheating reporting
  [∗]   Intel MCE features
  &lt; &gt; Machine check injector support
  Performance monitoring  ---&gt;
  [ ] Enable support for 16-bit segments
  [∗] Enable vsyscall emulation
  &lt; &gt; Dell i8k legacy laptop support
  [∗] CPU microcode loading support
  [∗]   Intel microcode loading support
  [ ]   AMD microcode loading support
  &lt;∗&gt; /dev/cpu/∗/msr - Model-specific register support
  &lt;∗&gt; /dev/cpu/∗/cpuid - CPU information support
  [∗] Numa Memory Allocation and Scheduler Support
  [ ]   Old style AMD Opteron NUMA detection
  [∗]   ACPI NUMA detection
  [ ]   NUMA emulation
  (2) Maximum NUMA Nodes (as a power of 2)
  Memory model (Sparse Memory)  ---&gt;
</code></pre>

<p><br/>
<hr/>
<h3>3- Installing Intel CPU Microcode Updates</h3>
<br/>
Gentoo Linux:</p>

<pre><code class="language-properties">emerge --sync &amp;&amp; emerge -av sys-firmware/intel-microcode
</code></pre>

<p><br/>
Void Linux:</p>

<pre><code class="language-properties">xbps-install -Su &amp;&amp; xbps-install -S intel-ucode
</code></pre>

<p><br/>
Arch Linux:</p>

<pre><code class="language-properties">pacman -Syu intel-ucode
</code></pre>

<p><br/>
Now hold on, don&rsquo;t follow your wiki&rsquo;s guide on how to build microcode updates with an initrd/initramfs, remember we&rsquo;re not using an initrd/initramfs here.
<br/>
<br/>
Instead, we&rsquo;re going to check to see if <mark>/lib/firmware</mark> was populated with intel&rsquo;s CPUs microcode update files:</p>

<pre><code class="language-bash">ls -l /lib/firmware
</code></pre>

<pre><code class="language-bash">drwxr-xr-x 2 root root 4096 Apr 13 21:47 intel-ucode
</code></pre>

<p><br/>
Alright, looks like a new folder <mark>intel-ucode</mark> was created. Let&rsquo;s see if it had the microcode update files:</p>

<pre><code class="language-bash">ls -l /lib/firmware/intel-ucode
</code></pre>

<pre><code class="language-properties">06-03-02  06-06-05  06-08-01  06-0a-01	06-0f-02  06-16-01  06-1c-02  06-26-01	06-3c-03  06-3f-04  06-56-02  0f-01-02	0f-03-02  0f-04-07  0f-06-05
06-05-00  06-06-0a  06-08-03  06-0b-01	06-0f-06  06-17-06  06-1c-0a  06-2a-07	06-3d-04  06-45-01  06-56-03  0f-02-04	0f-03-03  0f-04-08  0f-06-08
06-05-01  06-06-0d  06-08-06  06-0b-04	06-0f-07  06-17-07  06-1d-01  06-2d-06	06-3e-04  06-46-01  06-56-04  0f-02-05	0f-03-04  0f-04-09
06-05-02  06-07-01  06-08-0a  06-0d-06	06-0f-0a  06-17-0a  06-1e-05  06-2d-07	06-3e-06  06-47-01  06-5e-03  0f-02-06	0f-04-01  0f-04-0a
06-05-03  06-07-02  06-09-05  06-0e-08	06-0f-0b  06-1a-04  06-25-02  06-2f-02	06-3e-07  06-4e-03  0f-00-07  0f-02-07	0f-04-03  0f-06-02
06-06-00  06-07-03  06-0a-00  06-0e-0c	06-0f-0d  06-1a-05  06-25-05  06-3a-09	06-3f-02  06-4f-01  0f-00-0a  0f-02-09	0f-04-04  0f-06-04
</code></pre>

<p><br/>
Awesome, here are <strong>all</strong> of intel&rsquo;s CPUs microcode update files! Now, we have to do some research to figure out which file is the one to use for our cpu :D
<br/>
<hr/>
<h3>4- Choosing the Correct Microcode Update File</h3>
<br/>
The file names here are somewhat related to the CPUID signature. The default way to get your CPUID signature (as suggested by the <a href="https://wiki.gentoo.org/wiki/Intel_microcode#Software_3" target="_blank">Gentoo Wiki</a>) is to install a tool called <mark>iucode_tool</mark>:</p>

<pre><code class="language-properties">emerge --sync &amp;&amp; emerge -av sys-apps/iucode_tool
</code></pre>

<p><br/>
<mark>iucode_tool</mark> is also available in Arch&rsquo;s AUR. (This package isn&rsquo;t available on Void Linux by the time this article was written).
<br/>
<br/>
Now run this:</p>

<pre><code class="language-properties">iucode_tool -S
</code></pre>

<pre><code class="language-properties">iucode_tool: system has processor(s) with signature 0x000306c3
</code></pre>

<p><br/>
As you can see my CPUID signature is <mark>0x000306c3</mark>. If that didn&rsquo;t work for you then don&rsquo;t worry we have other ways as well to get your CPUID signature.
<br/>
<br/>
 You can do your research and find your CPUID signature. For example, my CPU is a <em>4th Gen. Intel Core i7 4700MQ</em>, a little googling and I found this on cpu-world.com :
<div class="frame"><img src="/img/cpuid.png" alt="cpuid"></div>
<br/>
Another way to do this is to install <mark>cpuid</mark>:</p>

<pre><code class="language-properties">emerge --sync &amp;&amp; emerge -av sys-apps/cpuid
</code></pre>

<p><br/>
<mark>cpuid</mark> is also available in Arch&rsquo;s AUR. (This package isn&rsquo;t available on Void Linux by the time this article was written).
<br/>
<br/>
Now run:</p>

<pre><code class="language-bash">cpuid | grep &quot;processor serial number&quot;
</code></pre>

<pre><code class="language-properties">      processor serial number                = false
   processor serial number: 0003-06C3-0000-0000-0000-0000
      processor serial number                = false
   processor serial number: 0003-06C3-0000-0000-0000-0000
      processor serial number                = false
   processor serial number: 0003-06C3-0000-0000-0000-0000
      processor serial number                = false
   processor serial number: 0003-06C3-0000-0000-0000-0000
      processor serial number                = false
   processor serial number: 0003-06C3-0000-0000-0000-0000
      processor serial number                = false
   processor serial number: 0003-06C3-0000-0000-0000-0000
      processor serial number                = false
   processor serial number: 0003-06C3-0000-0000-0000-0000
      processor serial number                = false
   processor serial number: 0003-06C3-0000-0000-0000-0000
</code></pre>

<p><br/>
Notice how it says processor serial number: <mark>0003-06C3</mark>-0000-0000-0000-0000. I&rsquo;ve highlighted this part <mark>0003-06C3</mark>.
<br/>
<br/>
Another way to do it, is to install <mark>dmidecode</mark>:
<br/>
<br/>
Gentoo Linux:</p>

<pre><code class="language-properties">emerge --sync &amp;&amp; emerge -av sys-apps/dmidecode
</code></pre>

<p><br/>
Void Linux:</p>

<pre><code class="language-properties">xbps-install -Su &amp;&amp; xbps-install -S dmidecode
</code></pre>

<p><br/>
Arch Linux:</p>

<pre><code class="language-properties">pacman -Syu dmidecode
</code></pre>

<p><br/>
Now run:</p>

<pre><code class="language-bash">dmidecode | grep -w ID
</code></pre>

<pre><code class="language-properties">  ID: 0
	ID: 1
	ID: 2
	ID: 3
	ID: 4
	ID: C3 06 03 00 FF FB EB BF
</code></pre>

<p><br/>
As you can see, (C, 3, 6, 0) are popping wherever I looked. You may simply choose to stop here if the signature was pretty obvious to you and you could easily identify the correct microcode update file to use (in my case I can easily tell that it&rsquo;s <mark>06-3c-03</mark>).
<br/>
<br/>
Now we can use <mark>iucode_tool</mark> to identify the correct microcode update file (and with the magic of grep):</p>

<pre><code class="language-bash">iucode_tool -L /lib/firmware/intel-ucode | grep 0x000306c3 -B 1
</code></pre>

<pre><code class="language-bash">microcode bundle 26: /lib/firmware/intel-ucode/06-3c-03
  026/001: sig 0x000306c3, pf_mask 0x32, 2017-01-27, rev 0x0022, size 22528
  026/002: sig 0x000306c3, pf_mask 0x32, 2017-01-27, rev 0x0022, size 22528
</code></pre>

<p><br/>
 As you can clearly see my microcode update file in <mark>/lib/firmware/intel-ucode</mark> is <mark>06-3c-03</mark>.
<br/>
<hr/>
<h3>5- Configuring the Linux Kernel to Build with the Correct Microcode Update File</h3>
<br/>
Woot.. The hard part is done, all we have to do right now is to tell the linux kernel the location of our microcode update file so that it&rsquo;ll be included in the kernel&rsquo;s build process.
<br/>
<br/>
Fire up your favorite terminal, and run:</p>

<pre><code class="language-bash">cd /usr/src/linux
</code></pre>

<pre><code class="language-bash">make menuconfig
</code></pre>

<p><br/>
Navigate to <mark>Device Drivers</mark> then to <mark>Generic Driver Options</mark>.
<br/>
<br/>
Now include <mark>CONFIG_FIRMWARE_IN_KERNEL</mark>,<mark>CONFIG_EXTRA_FIRMWARE</mark> and <mark>CONFIG_EXTRA_FIRMWARE_DIR</mark> as shown below:</p>

<pre><code class="language-properties">  [ ] Support for uevent helper
  -∗- Maintain a devtmpfs filesystem to mount at /dev
  [∗]   Automount devtmpfs at /dev, after the kernel mounted the rootfs
  [∗] Select only drivers that don't need compile-time external firmware
  [∗] Prevent firmware from being built
  -∗- Userspace firmware loading support
  [∗]   Include in-kernel firmware blobs in kernel binary
  (intel-ucode/06-3c-03) External firmware blobs to build into the kernel binary
  (/lib/firmware) Firmware blobs root directory
  [ ] Fallback user-helper invocation for firmware loading
  [ ] Allow device coredump
  [ ] Driver Core verbose debug messages
  [ ] Managed device resources verbose debug messages
  [ ] Test driver remove calls during probe (UNSTABLE)
  &lt; &gt; Build kernel module to test asynchronous driver probing
  [ ] Enable verbose DMA_FENCE_TRACE messages
</code></pre>

<p><br/>
Change:
<br/>
<br/>
<mark>CONFIG_EXTRA_FIRMWARE</mark> to <mark>intel-ucode/YOUR_MICROCODE_UPDATE_FILE_NAME</mark>
<br/>
<br/>
<mark>CONFIG_EXTRA_FIRMWARE_DIR</mark> to <mark>/lib/firmware</mark>
<br/>
<br/>
Save your configuration file, compile your kernel and reboot. Microcode updates should be working now without using an initrd.
<br/>
<hr/>
<h3>6- Verify that Microcode Updates are Working</h3>
This is quite simple, just run:</p>

<pre><code class="language-bash">dmesg | grep microcode
</code></pre>

<pre><code class="language-properties">[    0.000000] microcode: microcode updated early to revision 0x22, date = 2017-01-27
[    0.795219] microcode: sig=0x306c3, pf=0x10, revision=0x22
[    0.795433] microcode: Microcode Update Driver: v2.01 &lt;tigran@aivazian.fsnet.co.uk&gt;, Peter Oruba
</code></pre>

<p><br/>
As you can see, microcode updates are 100% working, final revision <mark>0x22</mark> is being used.
<br/>
<hr/>
<h3>Conclusion</h3>
If you followed our previous article <a href="https://www.dotslashlinux.com/post/Booting-the-Linux-Kernel-Without-an-initrd-initramfs.html" target="_blank">Booting the Linux Kernel Without an initrd/initramfs</a>, your boot folder now should only have the kernel inside it, as it contains everything from your modules to your microcode updates!
<br/></p>

</div>
<div id="comments" class="box">
  <h3>8 Comments</h3>
  <div class="main-comment">
    <p>atbd</p>
    <p>03/06/2017</p>
    <hr/>
    <p>Hello, thank you for your articles, this one particularly!
To be sure to not miss one, can you make them available via rss ?</p>
  </div>
  <div class="reply">
    <p>DOTSLASHLINUX</p>
    <p>03/06/2017</p>
    <hr/>
    <p>@atbd, you&rsquo;re most welcome! RSS feed is now available!</p>
  </div>
  <div class="main-comment">
    <p>atbd</p>
    <p>03/06/2017</p>
    <hr/>
    <p>By the way, I found a « method » to be sure about microcode signature:
*  install iucode_tool (available on gentoo, i don&rsquo;t know for others)
* run <code>dmesg | grep microcode</code> &amp; search for signature
* run <code>iucode_tool -L /lib/firmware/intel-ucode/</code> and grep the signature found in your <code>dmesg</code></p>
  </div>
  <div class="reply">
    <p>DOTSLASHLINUX</p>
    <p>03/06/2017</p>
    <hr/>
    <p><p>@atbd, I agree that should be the most obvious way to get the signature;however, on some installations the output of &ldquo;dmesg&rdquo; may be a lot more that it can be truncated and the microcode part won&rsquo;t be shown, another thing is that the user may reduce the verbosity of dmesg so the microcode updates won&rsquo;t be shown.</p>

<p>The user might also be using a custom kernel build and has disabled &ldquo;early microcode updates support&rdquo; from his/her kernel.</p>

<p>The point is to get the signature from more than one source to successfully choose your microcode update file. Another way would be to choose all microcode update files and let the kernel pick the right one for you. That might work but still the article was intended to make things easier for the reader.</p>

<p>Thanks for your reply! Your suggestion is much appreciated!</p>
</p>
  </div>
  <div class="main-comment">
    <p>rabbit</p>
    <p>27/06/2017</p>
    <hr/>
    <p>Best article ever! Thank you a lot for your work! Great stuff!!!</p>
  </div>
  <div class="reply">
    <p>DOTSLASHLINUX</p>
    <p>27/06/2017</p>
    <hr/>
    <p>@rabbit, thanks a lot! Your feedback means a lot and it sure motivated me further more to continue writing useful articles. Really glad that you found this one helpful. And I&rsquo;m proud to say that part of this article was added to the Gentoo wiki.</p>
  </div>
  <div class="main-comment">
    <p>Joe</p>
    <p>07/11/2017</p>
    <hr/>
    <p><p>Thanks for this.</p>

<p>But the folder intel-ucode does not exist on Arch Linux after installing the package. It just installs a .img file in /boot which works with initrd only I guess!</p>

<p>Any tips appreciated!</p>
</p>
  </div>
  <div class="reply">
    <p>DOTSLASHLINUX</p>
    <p>10/11/2017</p>
    <hr/>
    <p><p>@Joe, Thanks and I&rsquo;m sorry to hear that. Arch linux tends to build the microcode update files as an image into the initramfs itself (which is the sane thing to do for a distribution targeting such a large user base). You can still manually download the microcode update files from Intel&rsquo;s website (a 2-3MB microcode-date.tgz file) and extract it to &lsquo;/lib/firmware&rsquo;. Make sure that it&rsquo;s owned by root:root and it has 755 permissions.</p>

<p>Hope that helps! Let me know if you have any more questions!</p>
</p>
  </div>
  <div id="leavecomment">
    <h3>Leave A Comment</h3>
    <form action="https://getsimpleform.com/messages?form_api_token=4458712617021cb12239cbfd2942b227" method="post">
      <input name="options[redirect]" type="hidden" value="https://www.dotslashlinux.com//post/building-intel-cpu-microcode-updates-directly-into-the-linux-kernel/#comments">
      <input name="options[slug]" type="hidden" value="building intel cpu microcode updates directly into the linux kernel">
      <input type="hidden" id="reply" name="fields[replying_to]" value="">
      <input name="fields[name]" type="text" placeholder="Name" required>
      <textarea rows="5" name="fields[comment]" placeholder="Your comment here.&#10;&#10;Comments support Markdown.&#10;&#10;Comments are being moderated to prevent spam so it may take a while before your comment is posted." required></textarea>
      <button type="submit">Submit</button>
    </form>
  </div>
</div>

<div class="box footer">
  <h4>Copyrights &copy; 2017-2018 <a href="/">DOTSLASHLINUX</a> | Licensed under <a id="creativecommons" href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a></h4>
</div>
</div>
</div>
<script src="/js/c.js"></script>
</body>
</html>

